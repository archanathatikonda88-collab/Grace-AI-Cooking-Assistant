<!DOCTYPE html>
<html>
<head>
    <title>Enhanced Recipe Detail Test</title>
    <link rel="stylesheet" href="/static/styles.css?v=16">
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            background: #f8f9fa;
        }
        .test-container { 
            max-width: 800px; 
            margin: 0 auto; 
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .test-header {
            background: linear-gradient(135deg, #ff6b35, #ff8c42);
            color: white;
            padding: 24px;
            text-align: center;
        }
        .test-section { 
            margin: 0;
            padding: 24px; 
            border-bottom: 1px solid #eee;
        }
        .test-section:last-child {
            border-bottom: none;
        }
        .test-button { 
            margin: 10px 5px; 
            padding: 12px 24px; 
            background: #ff6b35; 
            color: white; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }
        .test-button:hover {
            background: #e55a2b;
            transform: translateY(-1px);
        }
        .test-result { 
            margin: 15px 0; 
            padding: 16px; 
            background: #f8f9fa; 
            border-radius: 8px; 
            border-left: 4px solid #ff6b35;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
        }
        .success { border-left-color: #28a745; background: #f8fff9; }
        .error { border-left-color: #dc3545; background: #fff8f8; }
        
        /* Recipe preview styling */
        .recipe-preview {
            border: 1px solid #ddd;
            border-radius: 12px;
            overflow: hidden;
            margin-top: 16px;
        }
        
        .preview-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background: #f5f5f5;
        }
        
        .preview-content {
            padding: 20px;
        }
        
        h3 {
            color: #ff6b35;
            margin-top: 24px;
            margin-bottom: 12px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1>üç≥ Enhanced Recipe Detail Test Suite</h1>
            <p>Testing image display and detailed cooking instructions</p>
        </div>
        
        <div class="test-section">
            <h2>üîç API Endpoint Tests</h2>
            <button class="test-button" onclick="testSuggestEndpoint()">Test /suggest Endpoint</button>
            <button class="test-button" onclick="testRecipeDetail()">Test Recipe Detail API</button>
            <button class="test-button" onclick="testImageHandling()">Test Image Processing</button>
            <button class="test-button" onclick="testFullWorkflow()">Test Complete Workflow</button>
            <div id="api-results"></div>
        </div>
        
        <div class="test-section">
            <h2>üé® Recipe Display Preview</h2>
            <p>This shows how recipes will appear with the new enhancements:</p>
            
            <div class="recipe-preview">
                <img src="/static/images/default_cooking.jpg" alt="Recipe Image" class="preview-image" />
                <div class="preview-content">
                    <h1>Enhanced Indian Chicken Curry</h1>
                    <p>A rich and flavorful chicken curry with detailed instructions for beginners.</p>
                    
                    <div class="ingredients-section">
                        <h3>Ingredients</h3>
                        <ul>
                            <li><span class="ingredient-number">1.</span><span class="ingredient-text">2 pounds boneless chicken, cut into cubes</span></li>
                            <li><span class="ingredient-number">2.</span><span class="ingredient-text">2 large onions, finely chopped</span></li>
                            <li><span class="ingredient-number">3.</span><span class="ingredient-text">4 cloves garlic, minced</span></li>
                            <li><span class="ingredient-number">4.</span><span class="ingredient-text">2 inches fresh ginger, grated</span></li>
                            <li><span class="ingredient-number">5.</span><span class="ingredient-text">2 tablespoons vegetable oil</span></li>
                            <li><span class="ingredient-number">6.</span><span class="ingredient-text">1 tablespoon curry powder</span></li>
                        </ul>
                    </div>
                    
                    <div class="instructions-section">
                        <h3>Instructions</h3>
                        <ol>
                            <li><span class="instruction-number">1</span><span class="instruction-text">Heat 2 tablespoons of oil in a large, heavy-bottomed pan over medium heat for 1-2 minutes until the oil shimmers but doesn't smoke.</span></li>
                            <li><span class="instruction-number">2</span><span class="instruction-text">Add the finely chopped onions to the hot oil and saut√© for 8-10 minutes, stirring occasionally, until they turn golden brown and become translucent.</span></li>
                            <li><span class="instruction-number">3</span><span class="instruction-text">Add the minced garlic and grated ginger to the pan and cook for 1-2 minutes until fragrant and the raw smell completely disappears.</span></li>
                            <li><span class="instruction-number">4</span><span class="instruction-text">Sprinkle the curry powder over the aromatics and stir continuously for 30 seconds to toast the spices and release their flavors.</span></li>
                            <li><span class="instruction-number">5</span><span class="instruction-text">Add the chicken pieces to the pan and cook for 5-7 minutes, turning occasionally, until all sides are well-coated with the spice mixture and lightly browned.</span></li>
                            <li><span class="instruction-number">6</span><span class="instruction-text">Pour in 1 cup of water, bring to a gentle boil, then reduce heat to low, cover the pan, and simmer for 15-20 minutes until chicken is fully cooked through and tender.</span></li>
                            <li><span class="instruction-number">7</span><span class="instruction-text">Remove from heat, garnish with fresh cilantro leaves, and serve immediately over steamed basmati rice.</span></li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="test-section">
            <h2>‚úÖ Enhancement Summary</h2>
            <ul style="line-height: 1.8; color: #333;">
                <li>‚úÖ <strong>Fixed Image Display:</strong> Enhanced fallback system ensures images always load</li>
                <li>‚úÖ <strong>Enhanced Instructions:</strong> Detailed, beginner-friendly steps with timing and tips</li>
                <li>‚úÖ <strong>Better Parsing:</strong> Improved JavaScript to handle complex instruction formats</li>
                <li>‚úÖ <strong>Clean Formatting:</strong> Professional numbered lists with proper spacing</li>
                <li>‚úÖ <strong>AI Improvements:</strong> Enhanced prompts for more detailed recipe generation</li>
            </ul>
        </div>
    </div>
    
    <script>
        function showResult(elementId, message, isSuccess = true) {
            const element = document.getElementById(elementId);
            const className = isSuccess ? 'test-result success' : 'test-result error';
            element.innerHTML = `<div class="${className}">${message}</div>`;
        }
        
        async function testSuggestEndpoint() {
            try {
                showResult('api-results', 'Testing /suggest endpoint...', true);
                
                const response = await fetch('/suggest', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ingredients: 'chicken, rice',
                        cuisine: 'indian',
                        difficulty: 'easy'
                    })
                });
                
                const data = await response.json();
                const message = `‚úÖ /suggest Endpoint Test Results:
Status: ${response.status}
Cards returned: ${data.cards ? data.cards.length : 0}
${data.cards && data.cards.length > 0 ? 
  `First recipe: ${data.cards[0].name}
Recipe ID: ${data.cards[0].id}
Has image: ${!!data.cards[0].image}` : 'No cards returned'}`;
                
                showResult('api-results', message, response.status === 200);
            } catch (error) {
                showResult('api-results', `‚ùå Error testing /suggest: ${error.message}`, false);
            }
        }
        
        async function testRecipeDetail() {
            try {
                showResult('api-results', 'Testing recipe detail endpoint...', true);
                
                // First get a recipe ID
                const suggestResp = await fetch('/suggest', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ingredients: 'chicken', cuisine: 'indian', difficulty: 'easy' })
                });
                
                const suggestData = await suggestResp.json();
                if (!suggestData.cards || suggestData.cards.length === 0) {
                    throw new Error('No recipe cards returned from /suggest');
                }
                
                const recipeId = suggestData.cards[0].id;
                
                // Then get recipe details
                const detailResp = await fetch(`/api/recipe/${recipeId}`);
                const detailData = await detailResp.json();
                
                const message = `‚úÖ Recipe Detail Test Results:
Status: ${detailResp.status}
Recipe: ${detailData.name}
Image URL: ${detailData.image ? 'Present ‚úì' : 'Missing ‚úó'}
Image starts with http/slash: ${detailData.image && (detailData.image.startsWith('http') || detailData.image.startsWith('/')) ? 'Yes ‚úì' : 'No ‚úó'}
Ingredients: ${detailData.ingredients ? detailData.ingredients.length + ' items' : 'Missing'}
Instructions: ${detailData.instructions ? 'Present (' + detailData.instructions.length + ' chars)' : 'Missing'}
Instructions preview: ${detailData.instructions ? detailData.instructions.substring(0, 100) + '...' : 'N/A'}`;
                
                showResult('api-results', message, detailResp.status === 200);
            } catch (error) {
                showResult('api-results', `‚ùå Error testing recipe detail: ${error.message}`, false);
            }
        }
        
        async function testImageHandling() {
            try {
                showResult('api-results', 'Testing image handling...', true);
                
                // Test if fallback images exist
                const fallbackImages = [
                    '/static/images/default_cooking.jpg',
                    '/static/images/spaghetti.jpg',
                    '/static/images/placeholder-recipe.jpg',
                    '/static/images/quinoa_salad.jpg'
                ];
                
                let results = 'Image Accessibility Test:\n';
                
                for (const imgUrl of fallbackImages) {
                    try {
                        const imgResp = await fetch(imgUrl, { method: 'HEAD' });
                        results += `${imgUrl}: ${imgResp.status === 200 ? '‚úÖ Available' : '‚ùå Not found'}\n`;
                    } catch (e) {
                        results += `${imgUrl}: ‚ùå Error loading\n`;
                    }
                }
                
                showResult('api-results', results, true);
            } catch (error) {
                showResult('api-results', `‚ùå Error testing images: ${error.message}`, false);
            }
        }
        
        async function testFullWorkflow() {
            try {
                showResult('api-results', 'Testing complete workflow...', true);
                
                let results = 'Complete Workflow Test:\n\n';
                
                // Step 1: Get suggestions
                results += '1. Getting recipe suggestions...\n';
                const suggestResp = await fetch('/suggest', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ingredients: 'chicken', cuisine: 'indian', difficulty: 'easy' })
                });
                
                if (suggestResp.status !== 200) {
                    throw new Error(`Suggest failed with status ${suggestResp.status}`);
                }
                
                const suggestData = await suggestResp.json();
                results += `   ‚úÖ Got ${suggestData.cards.length} recipe cards\n\n`;
                
                // Step 2: Get recipe details
                const recipeId = suggestData.cards[0].id;
                results += `2. Getting details for recipe ID ${recipeId}...\n`;
                
                const detailResp = await fetch(`/api/recipe/${recipeId}`);
                if (detailResp.status !== 200) {
                    throw new Error(`Detail fetch failed with status ${detailResp.status}`);
                }
                
                const detailData = await detailResp.json();
                results += `   ‚úÖ Got recipe details for: ${detailData.name}\n\n`;
                
                // Step 3: Validate enhancements
                results += '3. Validating enhancements...\n';
                
                const imageValid = detailData.image && (detailData.image.startsWith('http') || detailData.image.startsWith('/'));
                results += `   Image URL format: ${imageValid ? '‚úÖ Valid' : '‚ùå Invalid'}\n`;
                
                const hasIngredients = detailData.ingredients && detailData.ingredients.length > 0;
                results += `   Ingredients available: ${hasIngredients ? '‚úÖ Yes (' + detailData.ingredients.length + ' items)' : '‚ùå No'}\n`;
                
                const hasInstructions = detailData.instructions && detailData.instructions.length > 50;
                results += `   Detailed instructions: ${hasInstructions ? '‚úÖ Yes (' + detailData.instructions.length + ' chars)' : '‚ùå No'}\n\n`;
                
                results += '‚úÖ Complete workflow test passed!';
                
                showResult('api-results', results, true);
            } catch (error) {
                showResult('api-results', `‚ùå Workflow test failed: ${error.message}`, false);
            }
        }
        
        // Auto-run a basic test when page loads
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                testSuggestEndpoint();
            }, 1000);
        });
    </script>
</body>
</html>